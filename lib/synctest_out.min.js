/*
 * servermock synctest plugin 多平台同步测试：实现操作一个平台多个平台同步事件操作
 * version 2.0.0
 * @param  {[type]} synctest_origin server synctest监听的websocket源 默认"127.0.0.1:80"
 */
function synctest__(synctest_origin){
  !function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var o in n)("object"==typeof exports?exports:e)[o]=n[o]}}(this,()=>(()=>{"use strict";class e{constructor(){this.list=[]}add(e){if("function"==typeof e)this.list.push(e);else if(Array.isArray(e))for(let t=0;t<e.length;t++)this.add(e[t]);return this}fireWith(e,t){const n=this.list;for(let o=0;o<n.length;o++)n[o].apply(e,t);return this}fire(...e){return this.fireWith(this,e)}}return function(t){t.__synctest={};const n={};let o=0;const s="synccommand_"+(new Date).getTime(),c=[{ele:["window","document"],type:["DOMContentLoaded","load"]}];const l=new WebSocket("ws://{{ origin }}");function r(e){return Object.prototype.toString.call(e).slice(8,-1)}function i(...e){const t={stack:[],reset(){this.stack=[]},watch(e,t){this.stack.indexOf(e)>-1||(this.stack.push(e),t())}};function n(e,o,c){for(const l in o)if(Object.prototype.hasOwnProperty.call(o,l)){const i=o[l];if(c){const o=r(i),f="Array"===o,a="Object"===o||u(o,["Touch","TouchList"]);if(f||a){const o=r(e[l]);f&&"Array"!==o?e[l]=[]:f||"Object"===o||(e[l]={}),t.watch(i,function(){n(e[l],i,c)})}else s(i,l)&&(e[l]=i)}else s(i,l)&&(e[l]=i)}}let o,s,c=arguments.length,l=!1,i=0;!0===arguments[i]&&(l=!0,i++),o=arguments[i++];const f=--c;for(s="function"==typeof arguments[f]?arguments[f]:function(e){return void 0!==e};i<c;i++)try{n(o,arguments[i],l)}catch(e){console.log("extend log: ",arguments[i])}return o}function u(e,t){return t.indexOf(e)>-1}function f(e){const n=[];return function e(o){if(!o)return n;if(o===t)n.push("window");else if(o===t.document)n.push("document");else if(o===document.body)n.push("body");else{const t=o;if(t.id)return n.push("#"+t.id),n;t.classList&&t.classList.length?n.push("."+t.classList.toString().split(" ").join(".")):n.push(t.tagName),e(t.parentElement)}}(e),n.reverse().join(">")}l.onopen=function(e){!function(){T(t,["scroll","resize"]);const e=document.querySelectorAll("a");e.length&&function(e,t){for(let n=0,o=e.length;n<o;n++)m(e[n],t)}(e,"click");const n=document.querySelectorAll("input"),o=document.querySelectorAll("textarea");n.length&&w(n,["input","focus"]);o.length&&w(o,["input","focus"])}(),console.log("[synctest start success]")},l.onclose=function(e){console.log("[synctest closed please check the server or refresh this page]")},l.onmessage=function(o){!function(e){const{ele:t,listeners:n}=e;if(!t)return;const o="__synctest_event",s=new Event(o),c=function(t){i(t,e.event),console.log("new event:\t",t),t.preventDefault(),n&&n.fire(t)};h.call(t,o,c,!1),t.dispatchEvent(s),t.removeEventListener(o,c)}(function(o){const l=JSON.parse(o);let r,i;const f=l.selector;if(function(e,t){for(const n in t)if(u(e.ele,t[n].ele)&&u(e.type,t[n].type))return!0;return!1}({ele:f,type:l.type},c))return{event:{},type:"",ele:null,listeners:new e};r="window"===f?t:"document"===f?document:document.querySelector(f);if(!r)return{event:{},type:"",ele:null,listeners:new e};try{const t=r;i=n[t[s]]&&n[t[s]][l.type]?n[t[s]][l.type]:new e}catch(t){i=new e}switch(l.type){case"input":(r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement)&&(r.value=l.value||"");break;case"focus":r instanceof HTMLElement&&r.focus();break;case"scroll":if("scrollTop"in r){const e=r;e.scrollTop=l.scrollTop||0,e.scrollLeft=l.scrollLeft||0}else t.scrollTo(l.scrollLeft||0,l.scrollTop||0);break;case"click":r instanceof HTMLAnchorElement&&-1===r.href.indexOf("javascript")&&(location.href=r.href)}r instanceof HTMLInputElement&&(r.value=l.value||"");if(console.log("parse:\t",l),l.type.indexOf("touch")>-1&&l.event&&l.event.changedTouches){const e=l.event.changedTouches;e&&(e.item=function(t){return e[t]},l.event.targetTouches=l.event.touches=e)}return{event:l.event||{},type:l.type,ele:r,listeners:i}}(o.data))},l.onerror=function(e){console.log("[synctest closed please check the server or refresh this page]")};const a=function(e,n,o){let s=null,c=null;return n=o<n?n:o,function(){const l=this,r=(new Date).getTime(),i=arguments;null!==s&&clearTimeout(s),c||(c=r),o<=r-c?(e.apply(l,i),c=r):s=t.setTimeout(function(){e.apply(l,i)},n)}}(function(e,t){d(p(e,t))},150,200);function p(e,n){const o=e,s={selector:f(o),type:n.type};switch(n.type){case"input":(o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement)&&(s.value=o.value);break;case"scroll":if("scrollTop"in o){const e=o;s.scrollTop=e.scrollTop,s.scrollLeft=e.scrollLeft}else s.scrollTop=t.scrollY,s.scrollLeft=t.scrollX}return s.event={},s.dom=[],i(s.event,n,function(e,o){if(e instanceof Node||e===t)/[0-9]/.test(o)||s.dom.push({name:o,selector:f(n[o])});else if("function"!=typeof e&&!/[A-Z]/.test(o[0]))return s.event[o]=e,!0;return!1},!0),console.log("build:\t",n,s.event),console.log("build JSON:\t",JSON.stringify(s)),JSON.stringify(s)}function d(e){""!==e&&1===l.readyState&&l.send(e)}let h,y,v;function g(t,c,l){const r=this;r[s]||(r[s]=++o);const i=r[s];n[i]||(n[i]={}),n[i][t]||(n[i][t]=new e),n[i][t].add(function(e){"function"==typeof c?c.call(r,e):c&&"function"==typeof c.handleEvent&&c.handleEvent(e)});h.call(r,t,function(e){try{"scroll2"===e.type?a(this,e):d(p(this,e))}catch(e){console.log(e)}"function"==typeof c?c.call(this,e):c&&"function"==typeof c.handleEvent&&c.handleEvent(e)},l)}function m(e,t){e.addEventListener(t,function(e){console.log(t,e)},!1)}function T(e,t){for(let n=0,o=t.length;n<o;n++)m(e,t[n])}function w(e,t){for(let n=0,o=e.length;n<o;n++)T(e[n],t)}"EventTarget"in t?(h=EventTarget.prototype.addEventListener,EventTarget.prototype.addEventListener=g):(y=Window.prototype.addEventListener,v=Node.prototype.addEventListener,h=function(e,t,n){const o=this instanceof Window&&y?y:v;o&&o.call(this,e,t,n)},Window.prototype.addEventListener&&(Window.prototype.addEventListener=g),Node.prototype.addEventListener&&(Node.prototype.addEventListener=g))}(window),{}})());
}